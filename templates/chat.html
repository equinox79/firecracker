% my $channel = $_[0]->{handler}->args->[0];
% my $mxhr = $_[0]->{handler}->request->param('mxhr');
<?xml version="1.0" enoding="UTF-8" ?>
<html>
<head>
<title>FireCracker Demo</title>
<script src="/static/jquery-1.3.2.min.js"></script>
% if ($mxhr) {
<script src="/static/DUI.js"></script>
<script src="/static/Stream.js"></script>
% } else {
<script src="/static/jquery.ev.js"></script>
% }
<script src="/static/jquery.md5.js"></script>
<script src="/static/jquery.cookie.js"></script>
<script src="/static/jquery.oembed.js"></script>
<script src="/static/pretty.js"></script>

<script>
var cookieName = 'tatsumaki_chat_ident';
function doPost(el1, el) {
    var ident = el1.attr('value');
    if (ident) $.cookie(cookieName, ident, { path: '/chat' });
    var text = el.attr('value');
    if (!text) return;
    $.ajax({
        url: "/chat/<%= $channel %>/post",
        data: { ident: ident, text: text },
        type: 'post',
        dataType: 'json',
        success: function(r) { }
    });
    el.attr('value', '');
    return;
}

$(function(){
    var onNewEvent = function(e) {
        try {
            var src    = e.avatar || ("http://www.gravatar.com/avatar/" + $.md5(e.ident || 'foo'));
            var name   = e.name   || e.ident || 'Anonymous';
            var avatar = $('<img/>').attr('src', src).attr('alt', name);
            if (e.ident) {
                var link = e.ident.match(/https?:/) ? e.ident : 'mailto:' + e.ident;
                avatar = $('<a/>').attr('href', link).attr('target', '_blank').append(avatar);
            }
            avatar = $('<td/>').addClass('avatar').append(avatar);

            var message = $('<td/>').addClass('chat-message');
            if (e.text) message.text(e.text);
            if (e.html) message.html(e.html);
            message.find('a').oembed(null, { embedMethod: "append", maxWidth: 500 });
            var name = e.name || (e.ident ? e.ident.split('@')[0] : null);
            if (name)
                message.prepend($('<span/>').addClass('name').text(name+ ': '));

            var date = new Date(e.time * 1000);
            var meta = $('<td/>').addClass('meta').append(
                '(' +
                '<span class="pretty-time" title="' + date.toUTCString() + '">' + date.toDateString() + '</span>' +
                ' from ' + e.address + ')'
            );
            $('.pretty-time', meta).prettyDate();
            $('#messages').prepend($('<tr/>').addClass('message').append(avatar).append(message).append(meta));
            
            if(e.html.match(/p\.[0-9]{1,}/)){
                var page = e.html.split(".")[1];
                flashMovie.jumpTo(page);
                //updateSlideNumber();
            }

        } catch(e) { if (console) console.log(e) };
    }

    if (typeof DUI != 'undefined') {
        var s = new DUI.Stream();
        s.listen('application/json', function(payload) {
            var event = eval('(' + payload + ')');
            onNewEvent(event);
        });
        s.load('/chat/<%= $channel %>/mxhrpoll');
    } else {
        $.ev.handlers.message = onNewEvent;
        $.ev.loop('/chat/<%= $channel %>/poll?client_id=' + Math.random());
    }

    if ($.cookie(cookieName))
        $('#ident').attr('value', $.cookie(cookieName));

    window.setInterval(function(){ $(".pretty-time").prettyDate() }, 1000 * 30);
});
</script>

<script type="text/javascript" src="/static/swfobject.js"></script>    

<script type="text/javascript">
var flashMovie;

//Load the flash player. Properties for the player can be changed here.
function loadPlayer() {
    //allowScriptAccess from other domains
    var params = { allowScriptAccess: "always" };
    var atts = { id: "player" };

    //doc: The path of the file to be used
    //startSlide: The number of the slide to start from
    //rel: Whether to show a screen with related slideshows at the end or not. 0 means false and 1 is true..
    var flashvars = { doc : "thirst-upload-800x600-1215534320518707-8", startSlide : 1, rel : 0 };

    //Generate the embed SWF file
    swfobject.embedSWF("http://static.slidesharecdn.com/swf/ssplayer2.swf", "player", "400", "300", "8", null, flashvars, params, atts);

    //Get a reference to the player
    flashMovie = document.getElementById("player");
}

//Jump to the appropriate slide
function jumpTo(){
    flashMovie.jumpTo(parseInt(document.getElementById("slidenumber").value));
}

//Update the slide number in the field for the same
function updateSlideNumber(){
    document.getElementById("slidenumber").value = flashMovie.getCurrentSlide();
    $('#ident').val('system');
    $('#chat').val('p.' + flashMovie.getCurrentSlide());
    doPost($('#ident'), $('#chat'));
}
</script>

<link rel="stylesheet" href="/static/screen.css" />
<style>
#messages {
    margin-top: 1em;
    margin-right: 3em;
    width: 100%;
}
.avatar {
    width: 25px;
    vertical-align: top;
}
.avatar img {
    width: 25px; height: 25px;
    vertical-align: top;
    margin-right: 0.5em;
}
.chat-message {
    width: 70%;
}
.chat-message .name {
    font-weight: bold;
}
.meta {
    vertical-align: top;
    color: #888;
    font-size: 0.8em;
}
body {
    margin: 1em 2em
}
td {
    border : solid 1px orange;
}

</style>
</head>

<body onload="loadPlayer();">
<table>
<tr>
    <td style="width:800px;vertical-align:top;">
    <div id="player">
        You need Flash player 8+ and JavaScript enabled to view this video.
    </div>
    <div style="margin-left: 150px; margin-top: 10px;">
        <button onclick="flashMovie.first();updateSlideNumber();" type="button" value="First">First</button>
        <button onclick="flashMovie.previous();updateSlideNumber();" type="button" value="Previous">Previous</button>
        <button onclick="jumpTo();updateSlideNumber();" type="button" value="Go to">Go to</button>
        <input type="text" id="slidenumber" size="2" value="1" onkeydown="if (event.keyCode == 13) { jumpTo(); }"/>
        <button onclick="flashMovie.next();updateSlideNumber();" type="button" value="Next">Next</button>
        <button onclick="flashMovie.last();updateSlideNumber();" type="button" value="Last">Last</button>
    </div>

    </td>
    <td style="">
        <h1 class="chat-room-name">Chat room: <%= $channel %></h1>
        <!-- move this input out of form so Firefox can submit with enter key :/ -->
        Your email (for Gravatar): <input id="ident" type="text" name="ident" size="24"/>
        <form onsubmit="doPost($('#ident'), $('#chat')); return false">
            Something to say: <input id="chat" type="text" size="48"/>
        </form>
        <div style="height:500px;overflow-y:scroll;">
            <table id="messages"> </table>
        </div>
    </td>
</tr>
</table>
<div id="footer">Powered by <a href="http://github.com/miyagawa/Tatsumaki">Tatsumaki/<%= $Tatsumaki::VERSION %></a>.</div>

</body>
</html>
